<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Cement Plant WebXR Demo</title>
  <style>
      html, body { width: 100%; height: 100%; margin: 0; overflow: hidden; }
      canvas { width:100%; height:100%; touch-action:none; }
  </style>
  
  <!-- Babylon Core -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

  <!-- Babylon Loaders + XR UI -->
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <!-- Particle Helper -->
  <script src="https://cdn.babylonjs.com/babylon.particles.min.js"></script>

</head>
<body>
<canvas id="renderCanvas"></canvas>

<script>
/* ---------------------------------------------------------
   SETUP ENGINE + SCENE
--------------------------------------------------------- */

const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const createScene = async function () {
    const scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3.Black();

    /* ----------------------------------------------
       CAMERA
    ---------------------------------------------- */
    const camera = new BABYLON.UniversalCamera("cam", new BABYLON.Vector3(0, 1.6, 5), scene);
    camera.attachControl(canvas, true);

    /* ----------------------------------------------
       LIGHTING
    ---------------------------------------------- */
    const light = new BABYLON.HemisphericLight("h", new BABYLON.Vector3(0,1,0), scene);
    light.intensity = 1.2;

    const dir = new BABYLON.DirectionalLight("d", new BABYLON.Vector3(-2,-3,-2), scene);
    dir.intensity = 0.4;

    /* ----------------------------------------------
       ENVIRONMENT 360Â°
       Replace "pano.png" with your own panorama
    ---------------------------------------------- */
    const dome = new BABYLON.PhotoDome(
        "dome",
        "pano.png",
        {resolution: 4096, size: 50},
        scene
    );

    /* ----------------------------------------------
       FLOOR
    ---------------------------------------------- */
    const ground = BABYLON.MeshBuilder.CreateGround("g", {width:40, height:40}, scene);
    ground.material = new BABYLON.StandardMaterial("gm", scene);
    ground.material.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.2);
    ground.material.specularColor = BABYLON.Color3.Black();

    /* ----------------------------------------------
       Pabrik Semen: Kiln, Silo, Conveyor
    ---------------------------------------------- */

    // Rotary Kiln
    const kiln = BABYLON.MeshBuilder.CreateCylinder("kiln", {
        diameter: 2,
        height: 8,
        tessellation: 32
    }, scene);
    kiln.position = new BABYLON.Vector3(-5, 1, 0);
    kiln.rotation.z = Math.PI * 0.35;

    const kilnMat = new BABYLON.StandardMaterial("km", scene);
    kilnMat.diffuseColor = new BABYLON.Color3(0.4, 0.2, 0.1);
    kilnMat.emissiveColor = new BABYLON.Color3(0.8, 0.3, 0.1); // glowing clinker
    kiln.material = kilnMat;

    // Silos
    const silo = BABYLON.MeshBuilder.CreateCylinder("silo", {
        diameter: 3,
        height: 8
    }, scene);
    silo.position = new BABYLON.Vector3(5, 4, -4);

    const siloMat = new BABYLON.StandardMaterial("sm", scene);
    siloMat.diffuseColor = new BABYLON.Color3(0.75, 0.75, 0.75);
    silo.material = siloMat;

    // Conveyor
    const conveyor = BABYLON.MeshBuilder.CreateBox("belt", {
        width: 1,
        height: 0.2,
        depth: 10
    }, scene);
    conveyor.position = new BABYLON.Vector3(0, 1, -3);
    conveyor.rotation.y = 0.5;

    let conveyorOffset = 0;

    /* ----------------------------------------------
       PARTICLE SYSTEM: Smoke
    ---------------------------------------------- */
    const smokeSystem = new BABYLON.ParticleSystem("smoke", 3000, scene);
    smokeSystem.particleTexture = new BABYLON.Texture("https://playground.babylonjs.com/textures/flare.png", scene);
    smokeSystem.emitter = new BABYLON.Vector3(5, 8, -4);
    smokeSystem.minSize = 0.5;
    smokeSystem.maxSize = 2;
    smokeSystem.minLifeTime = 1.5;
    smokeSystem.maxLifeTime = 3;
    smokeSystem.emitRate = 500;
    smokeSystem.direction1 = new BABYLON.Vector3(-0.2, 1, 0);
    smokeSystem.direction2 = new BABYLON.Vector3(0.2, 1, 0);
    smokeSystem.color1 = new BABYLON.Color4(0.8,0.8,0.8,0.6);
    smokeSystem.color2 = new BABYLON.Color4(0.5,0.5,0.5,0.4);
    smokeSystem.start();

    /* ----------------------------------------------
       PARTICLE SYSTEM: Dust
    ---------------------------------------------- */
    const dust = new BABYLON.ParticleSystem("dust", 2000, scene);
    dust.particleTexture = new BABYLON.Texture("https://playground.babylonjs.com/textures/flare.png", scene);
    dust.emitter = kiln;
    dust.minSize = 0.1;
    dust.maxSize = 0.4;
    dust.emitRate = 800;
    dust.color1 = new BABYLON.Color4(0.6,0.6,0.6,0.3);
    dust.start();

    /* ----------------------------------------------
       Sparks (near kiln)
    ---------------------------------------------- */
    const sparks = new BABYLON.ParticleSystem("sparks", 400, scene);
    sparks.particleTexture = new BABYLON.Texture("https://playground.babylonjs.com/textures/flare.png", scene);
    sparks.emitter = new BABYLON.Vector3(-5, 1.5, 0);
    sparks.color1 = new BABYLON.Color4(1, 0.6, 0.1, 1);
    sparks.color2 = new BABYLON.Color4(1, 0.3, 0.1, 1);
    sparks.minSize = 0.1;
    sparks.maxSize = 0.3;
    sparks.minEmitBox = new BABYLON.Vector3(-0.5, 0, -0.5);
    sparks.maxEmitBox = new BABYLON.Vector3(0.5, 0, 0.5);
    sparks.minLifeTime = 0.3;
    sparks.maxLifeTime = 0.8;
    sparks.direction1 = new BABYLON.Vector3(-1, 2, 1);
    sparks.direction2 = new BABYLON.Vector3(1, 2, -1);
    sparks.emitRate = 200;
    sparks.start();

    /* ----------------------------------------------
       LEVER & VALVE INTERACTION
    ---------------------------------------------- */

    // Valve (simple sphere)
    const valve = BABYLON.MeshBuilder.CreateSphere("valve", {diameter: 0.5}, scene);
    valve.position = new BABYLON.Vector3(2, 1.2, -2);

    // Detect click / controller select
    valve.actionManager = new BABYLON.ActionManager(scene);
    let valveOpen = false;

    valve.actionManager.registerAction(
        new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function() {
            valveOpen = !valveOpen;
            valve.material = new BABYLON.StandardMaterial("vm", scene);
            valve.material.diffuseColor = valveOpen ?
                new BABYLON.Color3(0,1,0) :
                new BABYLON.Color3(1,0,0);
        })
    );

    /* ----------------------------------------------
       XR SUPPORT
    ---------------------------------------------- */
    const xr = await scene.createDefaultXRExperienceAsync({uiOptions:{sessionMode:"immersive-vr"}});

    /* ----------------------------------------------
       ANIMATION LOOP
    ---------------------------------------------- */
    scene.onBeforeRenderObservable.add(() => {
        // Kiln rotation
        kiln.rotation.y += 0.01;

        // Conveyor belt movement (change texture offset)
        conveyorOffset += 0.01;
    });

    return scene;
};

createScene().then((scene) => {
    engine.runRenderLoop(() => {
        scene.render();
    });
});

window.addEventListener("resize", function () {
    engine.resize();
});
</script>
</body>
</html>
